## Сервис по работе с биржей Binance

### Что умеет:
> Получать все доступные пары по рест
> Получать минутные свечи по паре по рест (прокси на /api/v3/klines)
> Можно запросить все самые новые минутные свечи по всем парам и записать их в базу
> Можно запрашивать минутные свечи массово и биржа не заблокирует. Сделан ограничитель запросов
> Подключается к вебсоккету и слушает стримы минутных свечей для всех пар. Все данные записываются в базу 
> По запросу свечи у сервиса, сначала смотрится в базе, и если там нет то тогда запрашивается биржа

### Стэк:
> Язык - Python
> HTTP Сервер - aiohttp
> БД - Clickhouse
> Тестирование - PyTest
> Деплой- docker-compose

> Python + aiohttp позволяет писать достаточно быстрый асинхронные код. Обрабатывать много запросов одновременно. По скорости он может приблизиться к go. Но в свою очередь, имеет более продвинутые средства языка и код гораздо чище.
> Еще один плюс в сторону этого стэка, это еще то что однозначно понадобится проводить анализ и обработку данных. А Python это одна из самых популярных платформ для DataScience. Будет удобно использовать одни и те-же технологии.
> Для базы выбран Clickhouse. Это колоночная база данных, которая очень легко масштабируется и очень быстро осуществляет запись, поиск, агрегацию. Менять данные там нельзя, а вот хранить и работать с потоком - самое то. Clickhouse может сам следить какие данные к нему пришли, и приводить их к нужному виду. Например удалять дубликаты, или схлопывать несколько фрэймов в один усредненный.

### Архитектура:
> Сервис API, сервис Listener и сервис Clickhouse.
> Сервис API отвечает за обращение по REST к бирже, запись этих результатов в базу, и поиск данных в базе
> Сервис Listener слушает стримы по вебсоккету и кладет их в базу
> Сервис Clickhouse - БД

> Код разделен на две части:
> 1. Индивидуальный код сервисов
> ..* ./services/api
> ..* ./services/listener
> 2. Общие модули
> ..* ./ca_common
> ..* ./ca_common/rest
> ..* ./ca_common/exchanges
> ..* ./ca_common/clickhouse

> Каждый сервис представляет собой http server который умеет слушать обращения по get запросу и реагировать на них. 

> Тестирование	
> * test_main.py
> ..* Тесты для запущенного сервиса. Проверяет базовые функции и массовые вызовы REST
> * ./ca_common/tests/test-clickhouse
> ..* Проверяет базовую доступность Clickhouse
> * ./ca_common/exchanges/tests/test-binance
> ..* Проверяет REST функционал по Binance

### Что надо добавить:
> Так как Clickhouse проводит преобразование новых данный раз в 15 минут, то в это время данных может быть больше чем хотелось бы(могут быть дубликаты, или более детальные свечи). Необходимо добавить Redis чтобы хранить актуальную картину там. Также - это ускорит получение свечей по API. Так как самые новые будут в кэше.
> Когда понадобится масштабироваться, и будет сделано несколько инстансов сервисов, то надо будет добавить синхронизацию через Redis для запросов по  REST. Сейчас сервис ограничивает свои запросы к бирже исходя из внутреннего состояния. 
> Так-же когда будет много инстансов, надо добавить NGINX для распределения запросов. Так-же там из коробки кэширование запросов в связке с Redis.
> Доделать тесты которые будут сами запускать docker и потом тестировать. + более детально покрыть, ++
> Отдельным пунктом надо выделить логирование. Нужно настроить связку KLE.
> Ну и CI/CD надо настроить

### Как запусть:
```
git clone git@github.com:el-just/crypto_analytics.git
docker-compose up
```

### Как тестировать
```
	pip3 install -r requirements.txt
	запустить сервис
 	
	pytest test_main.py
	pytest ca_common/tests/test_clickhouse.py
	pytest ca_common/exchanges/test_binance.py
```
